# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Scribe** - A cold email generation platform for academic research outreach. The application uses FastAPI backend with Supabase authentication and PostgreSQL database, featuring a multi-step agentic pipeline for generating personalized emails.

**Tech Stack:**
- Backend: FastAPI, SQLAlchemy, Alembic, Python 3.13
- Database: Supabase/PostgreSQL with direct connection
- Authentication: Supabase Auth with JWT validation
- AI/ML: Anthropic Claude API, OpenAI (legacy)
- Web Scraping: BeautifulSoup, scholarly, httpx

## Development Commands

### Running the Application

```bash
# Start development server (with hot reload)
uvicorn main:app --reload --host 0.0.0.0 --port 8000

# Or using the main.py directly
python main.py

# Production (as per Procfile)
uvicorn main:app --host 0.0.0.0 --port $PORT --timeout-keep-alive 120
```

### Database Management

```bash
# Create a new migration after model changes
alembic revision --autogenerate -m "Description of changes"

# Apply migrations to database
alembic upgrade head

# Rollback one migration
alembic downgrade -1

# View current migration version
alembic current

# View migration history
alembic history --verbose
```

### Testing & Health Checks

```bash
# Health check endpoint
curl http://localhost:8000/health

# API documentation (auto-generated by FastAPI)
# Visit: http://localhost:8000/docs
```

## Architecture

### Backend-First Design

**CRITICAL**: This application follows a **BACKEND-FIRST** architecture:
- Frontend uses Supabase ONLY for authentication (OAuth, JWT)
- Backend handles ALL database operations using Supabase service role key
- Backend validates JWT tokens and extracts user_id from token (never trust request body)
- No direct database access from frontend

### Authentication Flow

```
Frontend (Next.js) -> Supabase Auth (Login/OAuth)
                   -> Get JWT token
                   -> Include token in API requests

Backend (FastAPI)  -> Validate JWT token via Supabase
                   -> Extract user_id from validated token
                   -> Perform database operations
                   -> Return response
```

**Authentication Dependencies** (api/dependencies.py):
- `get_supabase_user`: Validates JWT and returns Supabase user data (id, email)
- `get_current_user`: Fetches user from local database, requires initialization

### Database Models

**Users Table** (models/user.py):
- `id`: UUID from Supabase auth.users (primary key)
- `email`: User email (unique, indexed)
- `display_name`: Optional display name
- `generation_count`: Tracks number of emails generated
- `created_at`: Timestamp

**Emails Table** (models/email.py):
- `id`: Auto-generated UUID
- `user_id`: Foreign key to users table (CASCADE delete)
- `recipient_name`: Professor/recipient name
- `recipient_interest`: Research interest for personalization
- `email_message`: Generated email content
- `created_at`: Timestamp (indexed)

### Pipeline Architecture (In Development)

The email generation system uses a multi-step agentic pipeline located in `pipeline/`:

**Pipeline Steps:**
1. **Template Parser** - Analyzes email templates and extracts search parameters
2. **Web Scraper** - Fetches relevant information based on search terms
3. **ArXiv Helper** - Enriches with academic paper data (for RESEARCH template type)
4. **Email Composer** - Generates final personalized email

**Template Types** (pipeline/models/core.py):
- `RESEARCH`: Includes research papers the professor has written
- `BOOK`: Includes books the professor has written
- `GENERAL`: General information about the professor

**Job Status** (pipeline/models/core.py):
- `PENDING`: Job queued
- `RUNNING`: Currently processing
- `COMPLETED`: Successfully finished
- `FAILED`: Encountered error

### Configuration Management

**Environment Variables** (.env):
- All configuration via `config/settings.py` using Pydantic Settings
- Type-safe validation at startup
- Required variables will cause startup failure if missing

**Key Settings:**
- Database connection string auto-constructed from individual components
- CORS origins parsed from comma-separated string
- Supabase URL and service role key required
- Anthropic API key required for email generation

## API Endpoints

### User Management (`/api/user`)

**POST /api/user/init** - Initialize user profile (idempotent)
- Headers: `Authorization: Bearer {jwt_token}`
- Body: `{ "display_name": string }` (optional)
- Creates user in local database after Supabase auth
- Returns existing user if already initialized

**GET /api/user/profile** - Get current user profile
- Headers: `Authorization: Bearer {jwt_token}`
- Requires user to be initialized first

### Health & Info

**GET /health** - Health check with database status
**GET /** - API information and links to docs

## Development Patterns

### Adding New API Endpoints

1. Define Pydantic schemas in `schemas/` for request/response validation
2. Create route handler in `api/routes/` directory
3. Use authentication dependencies: `Depends(get_current_user)` for protected routes
4. Include router in `main.py` with `app.include_router()`
5. Database operations always in route handler or service layer, never in dependencies

### Database Changes

1. Modify models in `models/` directory (inherit from `Base`)
2. Run `alembic revision --autogenerate -m "description"`
3. Review generated migration in `alembic/versions/`
4. Apply with `alembic upgrade head`
5. Never skip Alembic - always use migrations for schema changes

### Authentication Requirements

**For protected endpoints:**
```python
from api.dependencies import get_current_user
from models.user import User

@router.get("/protected")
async def protected_route(
    current_user: User = Depends(get_current_user)
):
    # current_user is validated and from database
    # User ID is from JWT token, not request body
    pass
```

**NEVER:**
- Trust `user_id` from request body
- Use Supabase anon key in backend
- Allow frontend direct database access

### Pipeline Development

When working with the pipeline system:
1. Each step inherits from `BasePipelineStep` (pipeline/core/runner.py)
2. Implement `execute()` method returning `StepResult`
3. Steps communicate via `PipelineData` dataclass
4. Use structured logging via step logger
5. Handle errors gracefully and return detailed failure information

## Project Structure

```
/pythonserver
├── api/                    # FastAPI routes and dependencies
│   ├── routes/            # Route handlers (user.py, etc.)
│   ├── dependencies.py    # Auth dependencies
│   └── legacy/            # Old Flask code (deprecated)
├── models/                # SQLAlchemy ORM models
│   ├── user.py
│   └── email.py
├── schemas/               # Pydantic schemas for validation
│   └── auth.py
├── database/              # Database configuration and utilities
│   ├── base.py           # SQLAlchemy Base and engine
│   ├── session.py        # Session management
│   └── dependencies.py   # Database dependencies
├── services/              # External service integrations
│   └── supabase.py       # Supabase client
├── config/                # Application configuration
│   └── settings.py       # Pydantic Settings
├── pipeline/              # Email generation pipeline (in development)
│   ├── core/             # Pipeline runner and base classes
│   ├── models/           # Pipeline data models
│   └── steps/            # Pipeline step implementations
│       ├── template_parser/
│       ├── web_scraper/
│       ├── arxiv_helper/
│       └── email_composer/
├── alembic/               # Database migrations
│   └── versions/         # Migration files
├── prompts/               # Prompt templates for various tasks
├── main.py               # Application entry point
├── requirements.txt      # Python dependencies
└── alembic.ini          # Alembic configuration
```

## Important Notes

### Security
- Backend uses Supabase service role key (full database access)
- JWT tokens validated on every request
- Row Level Security (RLS) enabled on Supabase tables
- All sensitive credentials in .env (gitignored)

### Database Connection
- Direct PostgreSQL connection to Supabase (not Supabase SDK for queries)
- SQLAlchemy for ORM and query building
- Connection string requires `sslmode=require` for Supabase

### Migration from Firebase
- Original codebase used Firebase (now deprecated)
- All authentication migrated to Supabase
- Some legacy code remains in `api/legacy/` but is not used

### Pipeline Integration
- Pipeline system is under active development
- Will replace current email generation logic
- Uses Pydantic agents for structured workflows
- Designed for Celery worker integration (future)

## Common Workflows

### Adding a New Authenticated Endpoint

1. Create Pydantic schemas in `schemas/`
2. Create route in `api/routes/` using `get_current_user` dependency
3. Test with valid JWT token in Authorization header
4. Update this documentation if endpoint is commonly used

### Modifying Database Schema

1. Edit model in `models/`
2. Generate migration: `alembic revision --autogenerate -m "message"`
3. Review migration file
4. Apply: `alembic upgrade head`
5. Update corresponding Pydantic schemas in `schemas/`

### Debugging Authentication Issues

1. Check `/health` endpoint for Supabase connection status
2. Verify JWT token is valid (check expiration)
3. Ensure user is initialized with POST `/api/user/init`
4. Check server logs for detailed error messages
5. Verify environment variables are loaded correctly
